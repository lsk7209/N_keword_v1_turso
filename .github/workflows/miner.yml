name: Golden Keyword Miner Cron

on:
  schedule:
    # üöÄ Ï¥àÍ≥†ÏÑ±Îä• ÏÑ§Ï†ï: 5Î∂ÑÎßàÎã§ Ïã§Ìñâ (GitHub Actions ÏµúÏÜå Í∞ÑÍ≤©)
    # Î£®ÌîÑ ÏãúÍ∞ÑÏùÑ 4Î∂ÑÏúºÎ°ú ÎäòÎ†§ÏÑú Ï≤òÎ¶¨Îüâ Í∑πÎåÄÌôî
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  mine:
    runs-on: ubuntu-latest
    timeout-minutes: 7 # 4Î∂Ñ Î£®ÌîÑ + Ïó¨Ïú†ÏãúÍ∞Ñ
    concurrency:
      group: keyword-expand-cron
      cancel-in-progress: false
    
    steps:
      - name: Trigger Miner API
        id: mining
        run: |
          set -e  # ÏóêÎü¨ Ïãú Ï¶âÏãú Ï§ëÎã®
          
          # ÌôòÍ≤Ω Î≥ÄÏàò Í≤ÄÏ¶ù
          if [ -z "${{ secrets.PROD_URL }}" ] || [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "‚ùå ERROR: PROD_URL or CRON_SECRET is not set in GitHub Secrets."
            exit 1
          fi
          
          START_TIME=$(date +%s)
          echo "üöÄüöÄüöÄ Starting ULTRA HIGH-VOLUME mining at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # üöÄ Ï¥àÍ≥†ÏÑ±Îä• ÏÑ§Ï†ï: AD 14Í∞ú + SEARCH 30Í∞ú API ÌÇ§ ÏµúÎåÄ ÌôúÏö©
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # 
          # üìä API ÌÇ§ ÌôúÏö© Ï†ÑÎûµ:
          # - AD API (14Í∞ú): ÎùºÏö¥Îìú Î°úÎπàÏúºÎ°ú ÌÇ§Îãπ 15Ìöå ÏöîÏ≤≠ ‚Üí Î∂ÑÎãπ 210Ìöå Í∞ÄÎä•
          # - SEARCH API (30Í∞ú): ÏùºÏùº 25,000Ìöå √ó 30Í∞ú = 750,000Ìöå Í∞ÄÎä•
          # 
          # ‚ö° ÏµúÏ†ÅÌôî ÏàòÏπò (GitHub Actions 5Î∂Ñ Ï†úÌïú Ï§ÄÏàò):
          # - ÌÅ¨Î°† Ï£ºÍ∏∞: 5Î∂ÑÎßàÎã§ (ÌïòÎ£® 288Ìöå)
          # - Î£®ÌîÑ ÏãúÍ∞Ñ: 4Î∂Ñ (240Ï¥à)
          # - Ìò∏Ï∂ú Í∞ÑÍ≤©: 10Ï¥à (Î£®ÌîÑÎãπ 24Ìöå API Ìò∏Ï∂ú)
          # - Î∞∞Ïπò ÌÅ¨Í∏∞: 1500 ÏãúÎìú
          # - ÎèôÏãúÏÑ±: 150 (AD 14Í∞ú √ó 10 + Ïó¨Ïú†Î∂Ñ)
          # 
          # üìà ÏòàÏÉÅ Ï≤òÎ¶¨Îüâ:
          # - ÌÅ¨Î°†Îãπ: 24Ìöå √ó 1500ÏãúÎìú = 36,000 ÏãúÎìú Ï≤òÎ¶¨
          # - ÏùºÏùº: 288Ìöå √ó 36,000 = 10,368,000 ÏãúÎìú ÏãúÎèÑ
          # - ÏãúÎìúÎãπ 20Í∞ú Ïó∞Í¥ÄÌÇ§ÏõåÎìú ‚Üí Ïù¥Î°†Ï†Å 2ÏñµÍ∞ú
          # - Ï§ëÎ≥µ Ï†úÍ±∞ ÌõÑ Ïã§Ï†ú Ïã†Í∑ú: 15Îßå~25ÎßåÍ∞ú/Ïùº ÏòàÏÉÅ
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          RUN_FOR_SECONDS=240  # 4Î∂ÑÍ∞Ñ Î£®ÌîÑ Ïã§Ìñâ (5Î∂Ñ ÌÅ¨Î°† Ï£ºÍ∏∞ - 1Î∂Ñ Ïó¨Ïú†)
          INTERVAL_SECONDS=10  # 10Ï¥àÎßàÎã§ API Ìò∏Ï∂ú
          END_TIME=$((START_TIME + RUN_FOR_SECONDS))

          # üöÄüí∞ ÏµúÏ†ÅÌôî ÌååÎùºÎØ∏ÌÑ∞ (Turso ÎπÑÏö© ÏïàÏ†Ñ ÎßàÏßÑ ÌôïÎ≥¥)
          # - expandBatch=800 => 800 ÏãúÎìú/API Ìò∏Ï∂ú (Ï§ëÎ≥µ ÌïÑÌÑ∞ÎßÅÏúºÎ°ú Write 90% Ï†àÍ∞ê)
          # - expandConcurrency=100 => 100 ÎèôÏãú Ï≤òÎ¶¨ (AD 14Í∞ú √ó 7)
          # - minSearchVolume=100 => ÌíàÏßà Ïú†ÏßÄÎ•º ÏúÑÌïú ÏµúÏÜå Í≤ÄÏÉâÎüâ
          # - maxRunMs=58000 => Vercel 60Ï¥à Ï†úÌïú ÎÇ¥ ÏôÑÎ£å
          QUERY="task=expand&mode=TURBO&expandBatch=800&expandConcurrency=100&minSearchVolume=100&maxRunMs=58000"

          TOTAL_OK=0
          TOTAL_FAIL=0

          while [ $(date +%s) -lt $END_TIME ]; do
            echo "üì° Calling miner: ${{ secrets.PROD_URL }}/api/miner/execute?$QUERY"

            # Per-call retry (keep short)
            MAX_RETRIES=2
            RETRY_COUNT=0
            SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              RESPONSE=$(curl -X GET "${{ secrets.PROD_URL }}/api/miner/execute?$QUERY" \
                -H "CRON_SECRET: ${{ secrets.CRON_SECRET }}" \
                -w "\n%{http_code}" \
                --max-time 75 \
                --silent \
                --show-error) || true

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              if [ "$HTTP_CODE" = "200" ]; then
                SUCCESS=true
                TOTAL_OK=$((TOTAL_OK + 1))
                echo "‚úÖ HTTP $HTTP_CODE"
                echo "$BODY" | jq '.' || echo "$BODY"
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "‚ö†Ô∏è  HTTP $HTTP_CODE (retry $RETRY_COUNT/$MAX_RETRIES)"
                echo "Response: $BODY"
                sleep $((RETRY_COUNT * 3))
              fi
            done

            if [ "$SUCCESS" = "false" ]; then
              TOTAL_FAIL=$((TOTAL_FAIL + 1))
              echo "‚ùå Call failed after retries"
            fi

            sleep $INTERVAL_SECONDS
          done

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "üìà Loop summary: OK=$TOTAL_OK FAIL=$TOTAL_FAIL"
          echo "‚è±Ô∏è  Total execution time: ${DURATION} seconds"
          echo "üéâ ULTRA mining batch completed!"



name: Golden Keyword Miner Cron

on:
  schedule:
    - cron: '*/12 * * * *' # Run every 12 minutes (Deferred Writes ÏµúÏ†ÅÌôî ÌõÑ ÎπàÎèÑ Ï¶ùÍ∞Ä)
  workflow_dispatch: # Allow manual trigger

jobs:
  mine:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # 3Î∂Ñ ÌÅ¨Î°† ÎÇ¥ÏóêÏÑú Î£®ÌîÑ Ìò∏Ï∂úÎ°ú Ï≤òÎ¶¨Îüâ Í∑πÎåÄÌôî (8Î∂Ñ ‚Üí 10Î∂ÑÏúºÎ°ú Ï¶ùÍ∞Ä)
    concurrency:
      group: keyword-expand-cron
      cancel-in-progress: false
    
    steps:
      - name: Trigger Miner API
        id: mining
        run: |
          set -e  # ÏóêÎü¨ Ïãú Ï¶âÏãú Ï§ëÎã®
          
          # ÌôòÍ≤Ω Î≥ÄÏàò Í≤ÄÏ¶ù
          if [ -z "${{ secrets.PROD_URL }}" ] || [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "‚ùå ERROR: PROD_URL or CRON_SECRET is not set in GitHub Secrets."
            exit 1
          fi
          
          START_TIME=$(date +%s)
          echo "üöÄ Starting mining batch at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # üöÄ Write ÏµúÏ†ÅÌôî: Î∞∞Ïπò ÌÅ¨Í∏∞ Î∞è ÎπàÎèÑ ÎåÄÌè≠ Í∞êÏÜå
          # - Î∞∞Ïπò ÌÅ¨Í∏∞: 2000 ‚Üí 300 (85% Í∞êÏÜå)
          # - ÎèôÏãúÏÑ±: 130 ‚Üí 50 (62% Í∞êÏÜå)
          # - Ïã§Ìñâ ÏãúÍ∞Ñ: 7Î∂Ñ ‚Üí 3Î∂Ñ (57% Í∞êÏÜå)
          # - Ìò∏Ï∂ú Í∞ÑÍ≤©: 10Ï¥à ‚Üí 30Ï¥à (3Î∞∞ Ï¶ùÍ∞Ä)
          # ÏòàÏÉÅ Write Í∞êÏÜå: ÏïΩ 90% Ïù¥ÏÉÅ
          RUN_FOR_SECONDS=180  # 3Î∂ÑÍ∞Ñ Ïã§Ìñâ (7Î∂Ñ ‚Üí 3Î∂Ñ, 57% Í∞êÏÜå)
          INTERVAL_SECONDS=30  # 30Ï¥àÎßàÎã§ Ìò∏Ï∂ú (10Ï¥à ‚Üí 30Ï¥à, 3Î∞∞ Ï¶ùÍ∞Ä)
          END_TIME=$((START_TIME + RUN_FOR_SECONDS))

          # üöÄ Write ÏµúÏ†ÅÌôî: Î≥¥ÏàòÏ†Å ÏÑ§Ï†ï
          # üöÄ Deferred Writes ÏµúÏ†ÅÌôî ÌõÑ Î∞∞Ïπò ÌÅ¨Í∏∞ Ï¶ùÍ∞Ä
          # - expandBatch=400 => 400 ÏãúÎìú/Ïã§Ìñâ (300 ‚Üí 400, 33% Ï¶ùÍ∞Ä)
          # - expandConcurrency=50 => 50 ÎèôÏãúÏÑ± Ïú†ÏßÄ
          # - minSearchVolume=100 => ÏµúÏÜå Í≤ÄÏÉâÎüâ 100 Ïù¥ÏÉÅÎßå ÏàòÏßë
          # - ÏòàÏÉÅ Write: Î∞∞ÏπòÎãπ 3Ìöå (ÏÑ†Ï†ê + ÏÇΩÏûÖ + ÏÉÅÌÉú) = 99.8% Ï†àÏïΩ!
          QUERY="task=expand&mode=TURBO&expandBatch=400&expandConcurrency=50&minSearchVolume=100&maxRunMs=58000"

          TOTAL_OK=0
          TOTAL_FAIL=0

          while [ $(date +%s) -lt $END_TIME ]; do
            echo "üì° Calling miner: ${{ secrets.PROD_URL }}/api/miner/execute?$QUERY"

            # Per-call retry (keep short)
            MAX_RETRIES=2
            RETRY_COUNT=0
            SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              RESPONSE=$(curl -X GET "${{ secrets.PROD_URL }}/api/miner/execute?$QUERY" \
                -H "CRON_SECRET: ${{ secrets.CRON_SECRET }}" \
                -w "\n%{http_code}" \
                --max-time 75 \
                --silent \
                --show-error) || true

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              if [ "$HTTP_CODE" = "200" ]; then
                SUCCESS=true
                TOTAL_OK=$((TOTAL_OK + 1))
                echo "‚úÖ HTTP $HTTP_CODE"
                echo "$BODY" | jq '.' || echo "$BODY"
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "‚ö†Ô∏è  HTTP $HTTP_CODE (retry $RETRY_COUNT/$MAX_RETRIES)"
                echo "Response: $BODY"
                sleep $((RETRY_COUNT * 3))
              fi
            done

            if [ "$SUCCESS" = "false" ]; then
              TOTAL_FAIL=$((TOTAL_FAIL + 1))
              echo "‚ùå Call failed after retries"
            fi

            sleep $INTERVAL_SECONDS
          done

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "üìà Loop summary: OK=$TOTAL_OK FAIL=$TOTAL_FAIL"
          echo "‚è±Ô∏è  Total execution time: ${DURATION} seconds"
          echo "üéâ Mining batch completed successfully!"


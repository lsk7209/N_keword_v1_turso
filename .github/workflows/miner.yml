name: Golden Keyword Miner Cron

on:
  schedule:
    - cron: '*/5 * * * *' # Run every 5 minutes (UTC) - Í≥µÍ≤©Ï†Å Î™®Îìú
  workflow_dispatch: # Allow manual trigger

jobs:
  mine:
    runs-on: ubuntu-latest
    timeout-minutes: 8 # 5Î∂Ñ ÌÅ¨Î°† ÎÇ¥ÏóêÏÑú Î£®ÌîÑ Ìò∏Ï∂úÎ°ú Ï≤òÎ¶¨Îüâ Í∑πÎåÄÌôî
    concurrency:
      group: miner-cron
      cancel-in-progress: false
    
    steps:
      - name: Trigger Miner API
        id: mining
        run: |
          set -e  # ÏóêÎü¨ Ïãú Ï¶âÏãú Ï§ëÎã®
          
          # ÌôòÍ≤Ω Î≥ÄÏàò Í≤ÄÏ¶ù
          if [ -z "${{ secrets.PROD_URL }}" ] || [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "‚ùå ERROR: PROD_URL or CRON_SECRET is not set in GitHub Secrets."
            exit 1
          fi
          
          START_TIME=$(date +%s)
          echo "üöÄ Starting mining batch at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # ÏµúÎåÄ ÏàòÏßëÎüâ ÏµúÏ†ÅÌôî:
          # - GitHub schedule minimum is 5 minutes.
          # - Inside each run, repeatedly call the miner API for ~3 minutes to maximize daily throughput.
          # - Keep each API call within Vercel 60s by using controlled concurrency.
          # Goal: ÏµúÎåÄ ÌÇ§ÏõåÎìú ÏàòÏßëÎüâ Îã¨ÏÑ±
          # calls/day ~= (RUN_FOR_SECONDS/INTERVAL_SECONDS) * 288
          RUN_FOR_SECONDS=240  # 4Î∂ÑÍ∞Ñ Ïã§Ìñâ (180 ‚Üí 240, Îçî Í∏¥ Ïã§Ìñâ)
          INTERVAL_SECONDS=15  # 15Ï¥àÎßàÎã§ Ìò∏Ï∂ú (20 ‚Üí 15, Îçî ÏûêÏ£º Ìò∏Ï∂ú)
          END_TIME=$((START_TIME + RUN_FOR_SECONDS))

          # üöÄ ÌöçÍ∏∞Ï†Å ÏµúÏ†ÅÌôî: 13Í∞ú AD API ÌÇ§ ÏµúÎåÄ ÌôúÏö©
          # - expandBatch=500 => ~500 Ad API calls per miner execution (120 ‚Üí 500, 4Î∞∞ Ï¶ùÍ∞Ä)
          # - expandConcurrency=65 => 13Í∞ú ÌÇ§ √ó 5 = 65 ÎèôÏãúÏÑ± (12 ‚Üí 65, 5.4Î∞∞ Ï¶ùÍ∞Ä)
          # - minSearchVolume=1000 => ÏµúÏÜå Í≤ÄÏÉâÎüâ 1000 Ïù¥ÏÉÅÎßå ÏàòÏßë
          # Target: (180/20=9 calls/run) * 500 * 288 = 1,296,000 Ad calls/day
          # ÏòàÏÉÅ ÌÇ§ÏõåÎìú ÏàòÏßë: 1,296,000 ÏãúÎìú √ó 20Í∞ú ÌÇ§ÏõåÎìú/ÏãúÎìú = 25,920,000Í∞ú/Ïùº (Ïù¥Î°†ÏÉÅ)
          # Ïã§Ï†ú ÏïàÏ†Ñ: ÏïΩ 2,000,000-3,000,000Í∞ú/Ïùº (10Î∞∞ Ï¶ùÍ∞Ä)
          QUERY="task=expand&mode=TURBO&expandBatch=500&expandConcurrency=65&minSearchVolume=1000&maxRunMs=58000"

          TOTAL_OK=0
          TOTAL_FAIL=0

          while [ $(date +%s) -lt $END_TIME ]; do
            echo "üì° Calling miner: ${{ secrets.PROD_URL }}/api/miner/execute?$QUERY"

            # Per-call retry (keep short)
            MAX_RETRIES=2
            RETRY_COUNT=0
            SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              RESPONSE=$(curl -X GET "${{ secrets.PROD_URL }}/api/miner/execute?$QUERY" \
                -H "CRON_SECRET: ${{ secrets.CRON_SECRET }}" \
                -w "\n%{http_code}" \
                --max-time 75 \
                --silent \
                --show-error) || true

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              if [ "$HTTP_CODE" = "200" ]; then
                SUCCESS=true
                TOTAL_OK=$((TOTAL_OK + 1))
                echo "‚úÖ HTTP $HTTP_CODE"
                echo "$BODY" | jq '.' || echo "$BODY"
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "‚ö†Ô∏è  HTTP $HTTP_CODE (retry $RETRY_COUNT/$MAX_RETRIES)"
                echo "Response: $BODY"
                sleep $((RETRY_COUNT * 3))
              fi
            done

            if [ "$SUCCESS" = "false" ]; then
              TOTAL_FAIL=$((TOTAL_FAIL + 1))
              echo "‚ùå Call failed after retries"
            fi

            sleep $INTERVAL_SECONDS
          done

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "üìà Loop summary: OK=$TOTAL_OK FAIL=$TOTAL_FAIL"
          echo "‚è±Ô∏è  Total execution time: ${DURATION} seconds"
          echo "üéâ Mining batch completed successfully!"


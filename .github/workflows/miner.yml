name: Golden Keyword Miner Cron

on:
  schedule:
    # üöÄ Ï¥àÏïàÏ†ï Í≥†ÏàòÏßë: 15Î∂Ñ Ï£ºÍ∏∞Î°ú Ïö¥ÏòÅ (ÏÇ¨Ïö©Ïûê ÏöîÏ≤≠ Î∞òÏòÅ)
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  mine:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: keyword-expand-cron
      cancel-in-progress: false
    
    steps:
      - name: Trigger Miner API
        id: mining
        run: |
          set -e
          
          if [ -z "${{ secrets.PROD_URL }}" ] || [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "‚ùå ERROR: PROD_URL or CRON_SECRET is not set."
            exit 1
          fi
          
          START_TIME=$(date +%s)
          echo "üöÄüöÄüöÄ Starting STABLE HIGH-VOLUME mining at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # üìä 13Í∞ú AD API ÌÇ§ Í∏∞Î∞ò ÏµúÏ†ÅÌôî
          # - Ï¥àÏïàÏ†ï Î™®Îìú: Î∞∞Ïπò 200Í∞ú, ÎèôÏãúÏÑ± ÏûêÎèô Ï°∞Ï†à
          
          RUN_FOR_SECONDS=450  # 7.5Î∂ÑÍ∞Ñ Î£®ÌîÑ Ïã§Ìñâ
          INTERVAL_SECONDS=20  # 20Ï¥à Í∞ÑÍ≤©
          END_TIME=$((START_TIME + RUN_FOR_SECONDS))

          # ‚ö†Ô∏è Safe Mode: expandBatch=200, maxRunMs=40000 (40s)
          PARAMS="task=expand&mode=TURBO&expandBatch=200&expandConcurrency=130&minSearchVolume=30&maxRunMs=40000"
          API_URL="${{ secrets.PROD_URL }}/api/miner/execute?$PARAMS"

          TOTAL_OK=0
          TOTAL_FAIL=0

          while [ $(date +%s) -lt $END_TIME ]; do
            echo "üì° Calling miner: $API_URL"

            MAX_RETRIES=1
            RETRY_COUNT=0
            SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              RESPONSE=$(curl -X GET "$API_URL" \
                -H "CRON_SECRET: ${{ secrets.CRON_SECRET }}" \
                -w "\n%{http_code}" \
                --max-time 75 \
                --silent \
                --show-error) || true

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              if [ "$HTTP_CODE" = "200" ]; then
                SUCCESS=true
                TOTAL_OK=$((TOTAL_OK + 1))
                echo "‚úÖ HTTP $HTTP_CODE"
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "‚ö†Ô∏è  HTTP $HTTP_CODE (retry $RETRY_COUNT/$MAX_RETRIES)"
                echo "Response: $BODY"
                sleep 5
              fi
            done

            if [ "$SUCCESS" = "false" ]; then
              TOTAL_FAIL=$((TOTAL_FAIL + 1))
            fi

            sleep $INTERVAL_SECONDS
          done

          echo "üìà Loop summary: OK=$TOTAL_OK FAIL=$TOTAL_FAIL"
          echo "üéâ ULTRA stable mining completed!"

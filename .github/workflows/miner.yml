name: Golden Keyword Miner Cron

on:
  schedule:
    # ğŸš€ ì´ˆì•ˆì • ê³ ìˆ˜ì§‘: 15ë¶„ ì£¼ê¸°ë¡œ ìš´ì˜ (ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜)
    # ê¸°ì¡´ 10ë¶„ì—ì„œë„ ë§‰í˜”ë˜ ì´ìœ ëŠ” ë¹ˆë„ë³´ë‹¤ëŠ” 'ë™ì‹œì„±(130)'ì´ ë„ˆë¬´ ë†’ì•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
    # ì´ì œ 'ì ì‘í˜• ë™ì‹œì„±' ë¡œì§ì´ í‚¤ ìƒíƒœì— ë”°ë¼ ì†ë„ë¥¼ ìë™ ì¡°ì ˆí•˜ë¯€ë¡œ í›¨ì”¬ ì•ˆì „í•©ë‹ˆë‹¤.
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  mine:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: keyword-expand-cron
      cancel-in-progress: false
    
    steps:
      - name: Trigger Miner API
        id: mining
        run: |
          set -e
          
          if [ -z "${{ secrets.PROD_URL }}" ] || [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ ERROR: PROD_URL or CRON_SECRET is not set."
            exit 1
          fi
          
          START_TIME=$(date +%s)
          echo "ğŸš€ğŸš€ğŸš€ Starting STABLE HIGH-VOLUME mining at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # ğŸ“Š 13ê°œ AD API í‚¤ ê¸°ë°˜ ìµœì í™”
          # - ì ì‘í˜• ë™ì‹œì„±: í‚¤ê°€ ë§‰íˆë©´ ìë™ìœ¼ë¡œ ëŒ€ê¸°í•˜ê±°ë‚˜ ì†ë„ë¥¼ ëŠ¦ì¶¤
          # - 15ë¶„ ê°„ê²© ì‹¤í–‰ìœ¼ë¡œ ë„¤ì´ë²„ API ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜
          
          RUN_FOR_SECONDS=420  # 7ë¶„ê°„ ë£¨í”„ ì‹¤í–‰ (15ë¶„ ì£¼ê¸°ì— ë§ì¶° ë„‰ë„‰íˆ ì‹¤í–‰)
          INTERVAL_SECONDS=30  # 30ì´ˆ ê°„ê²© (ê¸´ í˜¸í¡ìœ¼ë¡œ ì•ˆì •ì  ìˆ˜ì§‘)
          END_TIME=$((START_TIME + RUN_FOR_SECONDS))

          # ë‚´ë¶€ ë¡œì§ì—ì„œ 13ê°œ í‚¤ ê¸°ì¤€ ì•½ 30~40 ë™ì‹œì„±ìœ¼ë¡œ ìë™ ì œí•œë¨
          PARAMS="task=expand&mode=TURBO&expandBatch=1000&expandConcurrency=130&minSearchVolume=30&maxRunMs=58000"
          API_URL="${{ secrets.PROD_URL }}/api/miner/execute?$PARAMS"

          TOTAL_OK=0
          TOTAL_FAIL=0

          while [ $(date +%s) -lt $END_TIME ]; do
            echo "ğŸ“¡ Calling miner: $API_URL"

            MAX_RETRIES=2
            RETRY_COUNT=0
            SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              RESPONSE=$(curl -X GET "$API_URL" \
                -H "CRON_SECRET: ${{ secrets.CRON_SECRET }}" \
                -w "\n%{http_code}" \
                --max-time 75 \
                --silent \
                --show-error) || true

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              if [ "$HTTP_CODE" = "200" ]; then
                SUCCESS=true
                TOTAL_OK=$((TOTAL_OK + 1))
                echo "âœ… HTTP $HTTP_CODE"
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "âš ï¸  HTTP $HTTP_CODE (retry $RETRY_COUNT/$MAX_RETRIES)"
                echo "Response: $BODY"
                sleep 10
              fi
            done

            if [ "$SUCCESS" = "false" ]; then
              TOTAL_FAIL=$((TOTAL_FAIL + 1))
            fi

            sleep $INTERVAL_SECONDS
          done

          echo "ğŸ“ˆ Loop summary: OK=$TOTAL_OK FAIL=$TOTAL_FAIL"
          echo "ğŸ‰ ULTRA stable mining completed!"

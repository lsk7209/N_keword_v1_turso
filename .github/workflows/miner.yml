name: Golden Keyword Miner Cron

on:
  schedule:
    - cron: '*/5 * * * *' # Run every 5 minutes (UTC) - ê³µê²©ì  ëª¨ë“œ
  workflow_dispatch: # Allow manual trigger

jobs:
  mine:
    runs-on: ubuntu-latest
    timeout-minutes: 8 # 5ë¶„ í¬ë¡  ë‚´ì—ì„œ ë£¨í”„ í˜¸ì¶œë¡œ ì²˜ë¦¬ëŸ‰ ê·¹ëŒ€í™”
    concurrency:
      group: miner-cron
      cancel-in-progress: false
    
    steps:
      - name: Trigger Miner API
        id: mining
        run: |
          set -e  # ì—ëŸ¬ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
          
          # í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
          if [ -z "${{ secrets.PROD_URL }}" ] || [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ ERROR: PROD_URL or CRON_SECRET is not set in GitHub Secrets."
            exit 1
          fi
          
          START_TIME=$(date +%s)
          echo "ğŸš€ Starting mining batch at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # ìµœëŒ€ ìˆ˜ì§‘ëŸ‰ ìµœì í™”:
          # - GitHub schedule minimum is 5 minutes.
          # - Inside each run, repeatedly call the miner API for ~3 minutes to maximize daily throughput.
          # - Keep each API call within Vercel 60s by using controlled concurrency.
          # Goal: ìµœëŒ€ í‚¤ì›Œë“œ ìˆ˜ì§‘ëŸ‰ ë‹¬ì„±
          # calls/day ~= (RUN_FOR_SECONDS/INTERVAL_SECONDS) * 288
          RUN_FOR_SECONDS=180  # 3ë¶„ê°„ ì‹¤í–‰ (120 â†’ 180)
          INTERVAL_SECONDS=20  # 20ì´ˆë§ˆë‹¤ í˜¸ì¶œ (30 â†’ 20, ë” ìì£¼ í˜¸ì¶œ)
          END_TIME=$((START_TIME + RUN_FOR_SECONDS))

          # ìµœëŒ€ ìˆ˜ì§‘ëŸ‰ ìµœì í™” íŒŒë¼ë¯¸í„° (14ê°œ ê²€ìƒ‰ê´‘ê³  API í‚¤ í™œìš©):
          # - expandBatch=120 => ~120 Ad API calls per miner execution (100 â†’ 120)
          # - expandConcurrency=12 => match 12 Ad keys (8 â†’ 12, 14ê°œ í‚¤ í™œìš©)
          # - minSearchVolume=1000 => ìµœì†Œ ê²€ìƒ‰ëŸ‰ 1000 ì´ìƒë§Œ ìˆ˜ì§‘
          # Target: (180/20=9 calls/run) * 120 * 288 = 311,040 Ad calls/day
          # ì˜ˆìƒ í‚¤ì›Œë“œ ìˆ˜ì§‘: 311,040 ì‹œë“œ Ã— 20ê°œ í‚¤ì›Œë“œ/ì‹œë“œ = 6,220,800ê°œ/ì¼ (ì´ë¡ ìƒ)
          # ì‹¤ì œ ì•ˆì „: ì•½ 225,000-300,000ê°œ/ì¼ (50-75% ì¦ê°€)
          QUERY="task=expand&expandBatch=120&expandConcurrency=12&minSearchVolume=1000&maxRunMs=55000"

          TOTAL_OK=0
          TOTAL_FAIL=0

          while [ $(date +%s) -lt $END_TIME ]; do
            echo "ğŸ“¡ Calling miner: ${{ secrets.PROD_URL }}/api/miner/execute?$QUERY"

            # Per-call retry (keep short)
            MAX_RETRIES=2
            RETRY_COUNT=0
            SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              RESPONSE=$(curl -X GET "${{ secrets.PROD_URL }}/api/miner/execute?$QUERY" \
                -H "CRON_SECRET: ${{ secrets.CRON_SECRET }}" \
                -w "\n%{http_code}" \
                --max-time 75 \
                --silent \
                --show-error) || true

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              if [ "$HTTP_CODE" = "200" ]; then
                SUCCESS=true
                TOTAL_OK=$((TOTAL_OK + 1))
                echo "âœ… HTTP $HTTP_CODE"
                echo "$BODY" | jq '.' || echo "$BODY"
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "âš ï¸  HTTP $HTTP_CODE (retry $RETRY_COUNT/$MAX_RETRIES)"
                echo "Response: $BODY"
                sleep $((RETRY_COUNT * 3))
              fi
            done

            if [ "$SUCCESS" = "false" ]; then
              TOTAL_FAIL=$((TOTAL_FAIL + 1))
              echo "âŒ Call failed after retries"
            fi

            sleep $INTERVAL_SECONDS
          done

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "ğŸ“ˆ Loop summary: OK=$TOTAL_OK FAIL=$TOTAL_FAIL"
          echo "â±ï¸  Total execution time: ${DURATION} seconds"
          echo "ğŸ‰ Mining batch completed successfully!"


name: Golden Keyword Miner Cron

on:
  # ğŸš¨ TURSO WRITE í•œë„ ì´ˆê³¼ë¡œ ìë™ ìˆ˜ì§‘ ì¼ì‹œ ì¤‘ë‹¨
  # í•„ìš” ì‹œ ìˆ˜ë™ìœ¼ë¡œ ì¬í™œì„±í™” (workflow_dispatchë¡œ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥)
  # schedule:
  #   - cron: '*/10 * * * *' # Run every 10 minutes (ë¹ˆë„ ê°ì†Œ)
  workflow_dispatch: # Allow manual trigger

jobs:
  mine:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # 3ë¶„ í¬ë¡  ë‚´ì—ì„œ ë£¨í”„ í˜¸ì¶œë¡œ ì²˜ë¦¬ëŸ‰ ê·¹ëŒ€í™” (8ë¶„ â†’ 10ë¶„ìœ¼ë¡œ ì¦ê°€)
    concurrency:
      group: keyword-expand-cron
      cancel-in-progress: false
    
    steps:
      - name: Trigger Miner API
        id: mining
        run: |
          set -e  # ì—ëŸ¬ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
          
          # í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
          if [ -z "${{ secrets.PROD_URL }}" ] || [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ ERROR: PROD_URL or CRON_SECRET is not set in GitHub Secrets."
            exit 1
          fi
          
          START_TIME=$(date +%s)
          echo "ğŸš€ Starting mining batch at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # ğŸš€ ìµœëŒ€ ìˆ˜ì§‘ëŸ‰ ìµœì í™” (API í‚¤ ìµœëŒ€ í™œìš©):
          # - GitHub schedule minimum is 5 minutes.
          # - Inside each run, repeatedly call the miner API for ~4 minutes to maximize daily throughput.
          # - Keep each API call within Vercel 60s by using controlled concurrency.
          # Goal: ìµœëŒ€ í‚¤ì›Œë“œ ìˆ˜ì§‘ëŸ‰ ë‹¬ì„±
          # calls/day ~= (RUN_FOR_SECONDS/INTERVAL_SECONDS) * 288
          RUN_FOR_SECONDS=420  # 7ë¶„ê°„ ì‹¤í–‰ (5ë¶„ ì£¼ê¸°ì— ë§ì¶° ìµœëŒ€ í™œìš©)
          INTERVAL_SECONDS=10  # 10ì´ˆë§ˆë‹¤ í˜¸ì¶œ (15 â†’ 10, ë” ìì£¼ í˜¸ì¶œ)
          END_TIME=$((START_TIME + RUN_FOR_SECONDS))

          # ğŸš€ íšê¸°ì  ìµœì í™”: API í‚¤ ìµœëŒ€ í™œìš©
          # - expandBatch=2000 => ~2000 Ad API calls per miner execution (500 â†’ 2000, 4ë°° ì¦ê°€)
          # - expandConcurrency=130 => 13ê°œ í‚¤ Ã— 10 = 130 ë™ì‹œì„± (65 â†’ 130, 2ë°° ì¦ê°€)
          # - minSearchVolume=100 => ìµœì†Œ ê²€ìƒ‰ëŸ‰ 100 ì´ìƒë§Œ ìˆ˜ì§‘
          # Target: (300/10=30 calls/run) * 2000 * 288 = 17,280,000 Ad calls/day
          # ì˜ˆìƒ í‚¤ì›Œë“œ ìˆ˜ì§‘: 17,280,000 ì‹œë“œ Ã— 20ê°œ í‚¤ì›Œë“œ/ì‹œë“œ = 345,600,000ê°œ/ì¼ (ì´ë¡ ìƒ)
          # ì‹¤ì œ ì•ˆì „: ì•½ 5,000,000-10,000,000ê°œ/ì¼ (ëŒ€í­ ì¦ê°€)
          QUERY="task=expand&mode=TURBO&expandBatch=2000&expandConcurrency=130&minSearchVolume=100&maxRunMs=58000"

          TOTAL_OK=0
          TOTAL_FAIL=0

          while [ $(date +%s) -lt $END_TIME ]; do
            echo "ğŸ“¡ Calling miner: ${{ secrets.PROD_URL }}/api/miner/execute?$QUERY"

            # Per-call retry (keep short)
            MAX_RETRIES=2
            RETRY_COUNT=0
            SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              RESPONSE=$(curl -X GET "${{ secrets.PROD_URL }}/api/miner/execute?$QUERY" \
                -H "CRON_SECRET: ${{ secrets.CRON_SECRET }}" \
                -w "\n%{http_code}" \
                --max-time 75 \
                --silent \
                --show-error) || true

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              if [ "$HTTP_CODE" = "200" ]; then
                SUCCESS=true
                TOTAL_OK=$((TOTAL_OK + 1))
                echo "âœ… HTTP $HTTP_CODE"
                echo "$BODY" | jq '.' || echo "$BODY"
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "âš ï¸  HTTP $HTTP_CODE (retry $RETRY_COUNT/$MAX_RETRIES)"
                echo "Response: $BODY"
                sleep $((RETRY_COUNT * 3))
              fi
            done

            if [ "$SUCCESS" = "false" ]; then
              TOTAL_FAIL=$((TOTAL_FAIL + 1))
              echo "âŒ Call failed after retries"
            fi

            sleep $INTERVAL_SECONDS
          done

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "ğŸ“ˆ Loop summary: OK=$TOTAL_OK FAIL=$TOTAL_FAIL"
          echo "â±ï¸  Total execution time: ${DURATION} seconds"
          echo "ğŸ‰ Mining batch completed successfully!"


name: Golden Keyword Miner Cron

on:
  schedule:
    # ğŸš€ ì´ˆì•ˆì • ê³ ìˆ˜ì§‘: 15ë¶„ ì£¼ê¸°ë¡œ ìš´ì˜ (ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜)
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  mine:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: keyword-expand-cron
      cancel-in-progress: false
    
    steps:
      - name: Trigger Miner API
        id: mining
        run: |
          set -e
          
          if [ -z "${{ secrets.PROD_URL }}" ] || [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ ERROR: PROD_URL or CRON_SECRET is not set."
            exit 1
          fi
          
          START_TIME=$(date +%s)
          echo "ğŸš€ğŸš€ğŸš€ Starting STABLE HIGH-VOLUME mining at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # ğŸ“Š 13ê°œ AD API í‚¤ ê¸°ë°˜ ìµœì í™”
          # - ì´ˆì•ˆì • ëª¨ë“œ: ë°°ì¹˜ 200ê°œ, ë™ì‹œì„± ìë™ ì¡°ì ˆ
          
          # ğŸ†• Step 1: ëŒ€ëŸ‰ í‚¤ì›Œë“œ í ì²˜ë¦¬ (ìˆëŠ” ê²½ìš°ë§Œ)
          echo "ğŸ“‹ Checking bulk queue..."
          QUEUE_URL="${{ secrets.PROD_URL }}/api/miner/execute?task=process_queue"
          QUEUE_RESPONSE=$(curl -s -X GET "$QUEUE_URL" \
            -H "CRON_SECRET: ${{ secrets.CRON_SECRET }}" \
            --max-time 60) || echo "{}"
          echo "Queue response: $QUEUE_RESPONSE"
          
          # Step 2: ì¼ë°˜ ë§ˆì´ë„ˆ ë£¨í”„ ì‹¤í–‰
          RUN_FOR_SECONDS=450  # 7.5ë¶„ê°„ ë£¨í”„ ì‹¤í–‰
          INTERVAL_SECONDS=20  # 20ì´ˆ ê°„ê²©
          END_TIME=$((START_TIME + RUN_FOR_SECONDS))

          # âš ï¸ Safe Mode: expandBatch=200, maxRunMs=40000 (40s)
          PARAMS="task=expand&mode=TURBO&expandBatch=200&expandConcurrency=130&minSearchVolume=30&maxRunMs=40000"
          API_URL="${{ secrets.PROD_URL }}/api/miner/execute?$PARAMS"

          TOTAL_OK=0
          TOTAL_FAIL=0

          while [ $(date +%s) -lt $END_TIME ]; do
            echo "ğŸ“¡ Calling miner: $API_URL"

            MAX_RETRIES=1
            RETRY_COUNT=0
            SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              RESPONSE=$(curl -X GET "$API_URL" \
                -H "CRON_SECRET: ${{ secrets.CRON_SECRET }}" \
                -w "\n%{http_code}" \
                --max-time 75 \
                --silent \
                --show-error) || true

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              if [ "$HTTP_CODE" = "200" ]; then
                SUCCESS=true
                TOTAL_OK=$((TOTAL_OK + 1))
                echo "âœ… HTTP $HTTP_CODE"
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "âš ï¸  HTTP $HTTP_CODE (retry $RETRY_COUNT/$MAX_RETRIES)"
                echo "Response: $BODY"
                sleep 5
              fi
            done

            if [ "$SUCCESS" = "false" ]; then
              TOTAL_FAIL=$((TOTAL_FAIL + 1))
            fi

            sleep $INTERVAL_SECONDS
          done

          echo "ğŸ“ˆ Loop summary: OK=$TOTAL_OK FAIL=$TOTAL_FAIL"
          echo "ğŸ‰ ULTRA stable mining completed!"

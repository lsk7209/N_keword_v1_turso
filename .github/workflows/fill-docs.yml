name: 📄 문서수 수집 크론 (Document Count Collection)

on:
  schedule:
    # 🚀 초안정 고수집: 15분 주기로 운영 (사용자 요청 반영)
    - cron: '0,15,30,45 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  fill_docs:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: document-fill-cron
      cancel-in-progress: false
    
    steps:
      - name: 📄 문서수 수집 시작
        id: fill_docs
        run: |
          set -e
          
          if [ -z "${{ secrets.PROD_URL }}" ] || [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "❌ ERROR: PROD_URL or CRON_SECRET is not set."
            exit 1
          fi
          
          START_TIME=$(date +%s)
          echo "📄🚀 Starting STABLE document count collection at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # 📊 29개 SEARCH API 키 기반 최적화
          RUN_FOR_SECONDS=450  # 7.5분간 루프 실행
          INTERVAL_SECONDS=20  # 20초 간격
          END_TIME=$((START_TIME + RUN_FOR_SECONDS))

          # ⚠️ maxRunMs를 45초로 하향하여 Vercel 504 Timeout 방지
          PARAMS="task=fill_docs&mode=TURBO&fillBatch=500&fillConcurrency=480&maxRunMs=45000"
          API_URL="${{ secrets.PROD_URL }}/api/miner/execute?$PARAMS"

          TOTAL_OK=0
          TOTAL_FAIL=0
          TOTAL_KEYWORDS=0

          while [ $(date +%s) -lt $END_TIME ]; do
            echo "📡 Calling: $API_URL"

            MAX_RETRIES=1
            RETRY_COUNT=0
            SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              RESPONSE=$(curl -X GET "$API_URL" \
                -H "CRON_SECRET: ${{ secrets.CRON_SECRET }}" \
                -w "\n%{http_code}" \
                --max-time 75 \
                --silent \
                --show-error) || true

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              if [ "$HTTP_CODE" = "200" ]; then
                SUCCESS=true
                TOTAL_OK=$((TOTAL_OK + 1))
                echo "✅ HTTP $HTTP_CODE"
                
                if command -v jq &> /dev/null; then
                  KEYWORDS_PROCESSED=$(echo "$BODY" | jq -r '.fillDocs?.processed // 0' 2>/dev/null || echo "0")
                  if [ "$KEYWORDS_PROCESSED" != "0" ] && [ "$KEYWORDS_PROCESSED" != "null" ]; then
                    TOTAL_KEYWORDS=$((TOTAL_KEYWORDS + KEYWORDS_PROCESSED))
                    echo "📊 처리된 키워드: ${KEYWORDS_PROCESSED}개"
                  fi
                fi
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "⚠️  HTTP $HTTP_CODE (retry $RETRY_COUNT/$MAX_RETRIES)"
                sleep 5
              fi
            done

            if [ "$SUCCESS" = "false" ]; then
              TOTAL_FAIL=$((TOTAL_FAIL + 1))
            fi

            sleep $INTERVAL_SECONDS
          done

          echo "📈 실행 요약: OK=$TOTAL_OK FAIL=$TOTAL_FAIL TotalKeywords=$TOTAL_KEYWORDS"
          echo "🎉 문서수 수집 완료!"

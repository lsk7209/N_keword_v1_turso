/**
 * âš¡ íšê¸°ì  DB ìµœì í™”: ì§€ì—° ì“°ê¸° (Deferred Writes) ì „ëµ
 *
 * ê¸°ì¡´: ì‹œë“œë‹¹ ì¦‰ì‹œ DB Write (INSERT + UPDATE)
 * ì‹ ê·œ: ë©”ëª¨ë¦¬ì— ì¶•ì  í›„ ë°°ì¹˜ Write (INSERTë§Œ)
 *
 * Write ê°ì†Œ íš¨ê³¼: ì‹œë“œë‹¹ 2-3íšŒ â†’ 1íšŒ (33-50% ì ˆì•½)
 */

import { getTursoClient, generateUUID, getCurrentTimestamp } from '@/utils/turso';
import { fetchRelatedKeywords, fetchDocumentCount } from '@/utils/naver-api';
import { isBlacklisted } from '@/utils/blacklist';

export interface MiningResult {
    processed: number; // Count of fully processed items (with doc count)
    saved: number; // Total items saved to DB
    items: any[]; // The fully processed items to return to UI
}

export async function processSeedKeyword(
    seedKeyword: string,
    limitDocCount = 0,
    skipDocFetch = false,
    minSearchVolume = 100,
    maxKeywords = 0
): Promise<MiningResult> {
    // ... existing validation code ...

    // ğŸš€ íšê¸°ì  ìµœì í™”: ë©”ëª¨ë¦¬ ê¸°ë°˜ ê²°ê³¼ ì¶•ì 
    // DB Writeë¥¼ ì™„ì „íˆ ì œê±°í•˜ê³  ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥
    let memoryResults: any[] = [];
    let memoryDeferredResults: any[] = [];

    // 1. Fetch Related Keywords (Ad API)
    // ... existing code ...

    // 2. Filter and Process
    // ... existing filtering code ...

    // ğŸš€ íšê¸°ì  ë³€ê²½: DB Write ì œê±°, ë©”ëª¨ë¦¬ë§Œ ì‚¬ìš©
    if (skipDocFetch) {
        // ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥, DB Write ì—†ìŒ
        memoryDeferredResults = candidatesToSaveOnly.map((r: any) => ({
            ...r,
            total_doc_cnt: null,
            blog_doc_cnt: 0,
            cafe_doc_cnt: 0,
            web_doc_cnt: 0,
            news_doc_cnt: 0,
            golden_ratio: 0,
            tier: 'UNRANKED',
            is_expanded: false
        }));
    } else {
        // ë¬¸ì„œ ìˆ˜ì§‘ ëŒ€ìƒë§Œ ë©”ëª¨ë¦¬ì— ì €ì¥
        candidatesToProcess.forEach((cand: any) => {
            memoryResults.push({
                keyword: cand.originalKeyword,
                total_search_cnt: cand.total_search_cnt,
                // ... other fields ...
                is_expanded: false
            });
        });

        candidatesToSaveOnly.forEach(cand => {
            memoryDeferredResults.push({
                keyword: cand.originalKeyword,
                // ... fields ...
                is_expanded: false
            });
        });
    }

    // ğŸš€ íšê¸°ì  ìµœì í™”: DB í˜¸ì¶œ ì™„ì „ ì œê±°
    // ê²°ê³¼ë§Œ ë©”ëª¨ë¦¬ì— ë°˜í™˜, ì‹¤ì œ DB WriteëŠ” í˜¸ì¶œì(batch-runner)ê°€ ë°°ì¹˜ë¡œ ì²˜ë¦¬
    const totalProcessed = memoryResults.length + memoryDeferredResults.length;

    console.log(`[MiningEngine] ğŸ“¦ Deferred Write: ${totalProcessed} keywords stored in memory (DB Write: 0)`);

    return {
        processed: memoryResults.length,
        saved: totalProcessed,
        items: [...memoryResults, ...memoryDeferredResults]
    };
}

// ğŸš€ íšê¸°ì  ìµœì í™”: ë²Œí¬ ë©”ëª¨ë¦¬ ê¸°ë°˜ ë°°ì¹˜ ì²˜ë¦¬ í•¨ìˆ˜ ì¶”ê°€
export async function bulkDeferredInsert(keywords: any[]): Promise<{ inserted: number }> {
    if (!keywords.length) return { inserted: 0 };

    const db = getTursoClient();

    // ğŸš€ ë‹¨ì¼ ë°°ì¹˜ INSERTë¡œ ëª¨ë“  í‚¤ì›Œë“œ ì²˜ë¦¬ (Write: 1íšŒ)
    const statements = keywords.map(kw => ({
        sql: `INSERT OR IGNORE INTO keywords (
            keyword, total_search_cnt, pc_search_cnt, mo_search_cnt,
            pc_click_cnt, mo_click_cnt, click_cnt, pc_ctr, mo_ctr, total_ctr,
            comp_idx, pl_avg_depth, total_doc_cnt, blog_doc_cnt, cafe_doc_cnt,
            web_doc_cnt, news_doc_cnt, golden_ratio, tier, is_expanded,
            created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
        args: [
            kw.keyword, kw.total_search_cnt, kw.pc_search_cnt || 0, kw.mo_search_cnt || 0,
            kw.pc_click_cnt || 0, kw.mo_click_cnt || 0, kw.click_cnt || 0,
            kw.pc_ctr || 0, kw.mo_ctr || 0, kw.total_ctr || 0,
            kw.comp_idx || 0, kw.pl_avg_depth || 0,
            kw.total_doc_cnt || null, kw.blog_doc_cnt || 0, kw.cafe_doc_cnt || 0,
            kw.web_doc_cnt || 0, kw.news_doc_cnt || 0,
            kw.golden_ratio || 0, kw.tier || 'UNRANKED', kw.is_expanded ? 1 : 0,
            getCurrentTimestamp(), getCurrentTimestamp()
        ]
    }));

    try {
        await db.batch(statements);
        console.log(`[MiningEngine] âš¡ Bulk Deferred Insert: ${keywords.length} keywords in 1 batch (Write: 1)`);
        return { inserted: keywords.length };
    } catch (e) {
        console.error('[MiningEngine] Bulk insert failed:', e);
        throw e;
    }
}